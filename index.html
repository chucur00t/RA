<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aplikasi Agenda Dinas Kominfo Kalbar - Modern</title>
    
    <!-- Tailwind CSS v3 -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        /* Gaya Kustom */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc; /* slate-50 */
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        .modal-backdrop {
            transition: opacity 0.3s ease;
        }
        .modal-content {
            transition: transform 0.3s ease, opacity 0.3s ease;
        }
        .hidden .modal-backdrop {
            opacity: 0;
        }
        .hidden .modal-content {
            opacity: 0;
            transform: translate(-50%, -60%);
        }
        .delete-cuti-btn i {
             pointer-events: none;
        }
        /* Custom scrollbar */
        .modal-content::-webkit-scrollbar {
            width: 8px;
        }
        .modal-content::-webkit-scrollbar-track {
            background: #f1f5f9;
        }
        .modal-content::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 10px;
        }
        .modal-content::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
    </style>
</head>
<body class="antialiased text-slate-800">

    <!-- Kontainer Login -->
    <div id="login-container" class="flex items-center justify-center min-h-screen bg-gradient-to-br from-slate-50 to-slate-200 p-4">
        <div class="w-full max-w-sm p-8 space-y-6 bg-white rounded-2xl shadow-xl">
            <div class="text-center mb-4">
                <h1 class="text-2xl font-bold text-slate-900">Aplikasi Agenda</h1>
                <p class="text-slate-500 mt-1">Dinas Komunikasi dan Informatika</p>
            </div>
            <form id="loginForm" class="space-y-6">
                <div>
                    <label for="username" class="block text-sm font-medium text-slate-700">Username</label>
                    <div class="mt-1">
                        <input id="username" name="username" type="text" required class="w-full px-4 py-2.5 border border-slate-300 rounded-lg shadow-sm placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition" value="admin">
                    </div>
                </div>
                <div>
                    <label for="password" class="block text-sm font-medium text-slate-700">Password</label>
                    <div class="mt-1">
                        <input id="password" name="password" type="password" required class="w-full px-4 py-2.5 border border-slate-300 rounded-lg shadow-sm placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition" value="admin123">
                    </div>
                </div>
                <p id="loginError" class="text-sm text-red-600 hidden">Username atau password salah.</p>
                <div>
                    <button type="submit" class="w-full flex justify-center py-3 px-4 border border-transparent rounded-lg shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-transform transform hover:scale-105">
                        Masuk
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Kontainer Aplikasi Utama (Hidden by default) -->
    <div id="app-container" class="hidden">
        <div class="container mx-auto p-4 sm:p-6 lg:p-8">
            
            <!-- Header -->
            <header class="bg-white/80 backdrop-blur-sm p-4 sm:p-6 rounded-2xl shadow-lg mb-8 sticky top-4 z-30">
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center">
                    <div>
                        <h1 class="text-2xl lg:text-3xl font-bold text-slate-900">Agenda Kegiatan</h1>
                        <p id="header-subtitle" class="text-slate-500 mt-1">Dinas Komunikasi dan Informatika</p>
                    </div>
                    <div class="flex items-center gap-2 mt-4 sm:mt-0 flex-wrap">
                        <button id="addCutiBtn" class="flex items-center gap-2 bg-amber-500 text-white font-semibold px-4 py-2 rounded-lg shadow-md hover:bg-amber-600 transition-all transform hover:scale-105">
                            <i data-lucide="calendar-plus" class="w-5 h-5"></i>
                            <span class="hidden sm:inline">Cuti Bersama</span>
                        </button>
                        <button id="addAgendaBtn" class="flex items-center gap-2 bg-indigo-600 text-white font-semibold px-4 py-2 rounded-lg shadow-md hover:bg-indigo-700 transition-all transform hover:scale-105">
                            <i data-lucide="plus-circle" class="w-5 h-5"></i>
                            <span class="hidden sm:inline">Tambah Agenda</span>
                        </button>
                         <button id="logoutBtn" class="flex items-center gap-2 bg-red-600 text-white font-semibold px-4 py-2 rounded-lg shadow-md hover:bg-red-700 transition-all transform hover:scale-105">
                            <i data-lucide="log-out" class="w-5 h-5"></i>
                            <span class="hidden sm:inline">Logout</span>
                        </button>
                    </div>
                </div>
            </header>

            <!-- Konten Utama: Filter dan Jadwal -->
            <div class="bg-white p-4 sm:p-6 rounded-2xl shadow-lg">
                <!-- Filter -->
                <div class="flex flex-col lg:flex-row lg:items-end gap-4 mb-6 pb-6 border-b border-slate-200">
                    <div class="flex-1">
                        <label for="pdFilter" class="flex items-center gap-2 text-sm font-medium text-slate-700 mb-2">
                            <i data-lucide="building-2" class="w-4 h-4 text-slate-500"></i>
                            <span>Perangkat Daerah</span>
                        </label>
                        <select id="pdFilter" class="block w-full px-3 py-2.5 bg-slate-100 border-slate-300 rounded-lg shadow-sm focus:outline-none cursor-not-allowed">
                            <option value="Dinas Komunikasi dan Informatika">Dinas Komunikasi dan Informatika</option>
                        </select>
                    </div>
                    <div class="flex-1">
                        <label for="monthFilter" class="flex items-center gap-2 text-sm font-medium text-slate-700 mb-2">
                            <i data-lucide="calendar" class="w-4 h-4 text-slate-500"></i>
                            <span>Pilih Bulan & Tahun</span>
                        </label>
                        <div class="flex gap-2">
                            <select id="monthFilter" class="block w-full px-3 py-2.5 bg-white border border-slate-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500">
                            </select>
                            <select id="yearFilter" class="block w-full md:w-32 px-3 py-2.5 bg-white border border-slate-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500">
                            </select>
                        </div>
                    </div>
                    <div class="flex-1">
                        <label for="adminFilter" class="flex items-center gap-2 text-sm font-medium text-slate-700 mb-2">
                            <i data-lucide="filter" class="w-4 h-4 text-slate-500"></i>
                            <span>Filter Penginput</span>
                        </label>
                        <select id="adminFilter" class="block w-full px-3 py-2.5 bg-white border border-slate-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500">
                            <option value="all">Semua</option>
                            <option value="Admin Dinas">Admin Dinas</option>
                            <option value="Admin Sekretariat">Admin Sekretariat</option>
                            <option value="Admin Bidang Aptika">Admin Bidang Aptika</option>
                            <option value="Admin Bidang Santis">Admin Bidang Santis</option>
                            <option value="Admin Bidang IP">Admin Bidang IP</option>
                            <option value="Admin Bidang KP">Admin Bidang KP</option>
                        </select>
                    </div>
                </div>

                <!-- Tampilan Jadwal -->
                <main id="schedule-container" class="space-y-8">
                    <!-- Konten jadwal akan dirender di sini -->
                </main>
            </div>
        </div>

        <!-- Modal (shared structure) -->
        <div id="agendaModal" class="hidden fixed inset-0 z-40 flex items-center justify-center p-4">
            <div class="modal-backdrop fixed inset-0 bg-black/50 backdrop-blur-sm"></div>
            <div class="modal-content relative bg-white w-11/12 md:w-2/3 max-w-3xl rounded-2xl shadow-xl max-h-[90vh] overflow-y-auto">
                <div class="p-6 border-b sticky top-0 bg-white/80 backdrop-blur-sm z-10">
                    <h2 id="modalTitle" class="text-2xl font-bold">Tambah Agenda Baru</h2>
                    <p id="modalPdSubtitle" class="text-sm text-slate-500 mt-1"></p>
                </div>
                <form id="agendaForm">
                    <input type="hidden" id="eventId">
                    <input type="hidden" id="perangkatDaerahValue">
                    <div class="p-6 space-y-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="md:col-span-2">
                                <label for="jenisAgenda" class="block text-sm font-medium text-slate-700 mb-1">Jenis Agenda</label>
                                <select id="jenisAgenda" class="w-full px-4 py-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                                    <option value="Eksternal">Eksternal (Undangan)</option>
                                    <option value="Internal">Internal</option>
                                </select>
                            </div>
                            <div class="md:col-span-2">
                                <label for="perihal" class="block text-sm font-medium text-slate-700 mb-1">Perihal Kegiatan</label>
                                <input type="text" id="perihal" class="w-full px-4 py-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500" required>
                            </div>
                            <div>
                                <label for="waktuMulai" class="block text-sm font-medium text-slate-700 mb-1">Waktu Mulai</label>
                                <input type="datetime-local" id="waktuMulai" class="w-full px-4 py-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500" required>
                            </div>
                            <div>
                                <label for="waktuSelesai" class="block text-sm font-medium text-slate-700 mb-1">Waktu Selesai</label>
                                <input type="datetime-local" id="waktuSelesai" class="w-full px-4 py-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500" required>
                            </div>
                            <div class="md:col-span-2">
                                <label for="tempat" class="block text-sm font-medium text-slate-700 mb-1">Tempat</label>
                                <input type="text" id="tempat" class="w-full px-4 py-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500" required>
                            </div>
                        </div>
                        <div id="eksternalFields" class="space-y-6 border-t pt-6">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div><label for="asalSurat" class="block text-sm font-medium text-slate-700 mb-1">Asal Surat / Penyelenggara</label><input type="text" id="asalSurat" class="w-full px-4 py-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500"></div>
                                <div><label for="pakaian" class="block text-sm font-medium text-slate-700 mb-1">Pakaian</label><input type="text" id="pakaian" class="w-full px-4 py-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500" placeholder="Contoh: Batik, PDH"></div>
                                <div class="md:col-span-2"><label for="disposisi" class="block text-sm font-medium text-slate-700 mb-1">Disposisi</label><textarea id="disposisi" rows="3" class="w-full px-4 py-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500" placeholder="Contoh: Mohon dihadiri..."></textarea></div>
                                <div class="md:col-span-2"><label for="petugas" class="block text-sm font-medium text-slate-700 mb-1">Petugas yang Ditugaskan</label><input type="text" id="petugas" class="w-full px-4 py-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500" placeholder="Pisahkan dengan koma"></div>
                            </div>
                        </div>
                        <div id="internalFields" class="space-y-4 border-t pt-6"><div class="flex items-center"><input type="checkbox" id="publishWebsite" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500"><label for="publishWebsite" class="ml-3 block text-sm text-gray-900">Publikasikan agenda ini di website dinas</label></div></div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 border-t pt-6">
                            <div><label for="status" class="block text-sm font-medium text-slate-700 mb-1">Status</label><select id="status" class="w-full px-4 py-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500"><option>Terjadwal</option><option>Selesai</option><option>Dibatalkan</option></select></div>
                            <div><label for="createdBy" class="block text-sm font-medium text-slate-700 mb-1">Diinput oleh</label><select id="createdBy" class="w-full px-4 py-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500"></select></div>
                        </div>
                    </div>
                    <div class="p-4 sm:p-6 bg-slate-50 rounded-b-2xl flex justify-end gap-3 sticky bottom-0 z-10">
                        <button type="button" id="cancelBtn" class="px-5 py-2.5 bg-slate-200 text-slate-700 rounded-lg hover:bg-slate-300 font-semibold transition">Batal</button>
                        <button type="submit" class="px-5 py-2.5 bg-indigo-600 text-white font-semibold rounded-lg shadow-sm hover:bg-indigo-700 transition">Simpan Agenda</button>
                    </div>
                </form>
            </div>
        </div>

        <div id="detailModal" class="hidden fixed inset-0 z-40 flex items-center justify-center p-4">
            <div class="modal-backdrop fixed inset-0 bg-black/50 backdrop-blur-sm"></div>
            <div class="modal-content relative bg-white w-11/12 md:w-1/2 max-w-2xl rounded-2xl shadow-xl max-h-[90vh] overflow-y-auto">
                <div class="p-6 border-b flex justify-between items-start sticky top-0 bg-white/80 backdrop-blur-sm z-10">
                    <div><h2 id="detailTitle" class="text-2xl font-bold text-slate-900"></h2><p id="detailCreatedBy" class="text-sm text-slate-500 mt-1"></p></div>
                    <button id="closeDetailBtn" class="text-slate-500 hover:text-slate-800 transition"><i data-lucide="x" class="w-6 h-6"></i></button>
                </div>
                <div id="detailContent" class="p-6 space-y-5"></div>
                <div class="p-4 sm:p-6 bg-slate-50 rounded-b-2xl flex justify-end gap-3 sticky bottom-0 z-10">
                    <button type="button" id="deleteBtn" class="px-4 py-2.5 bg-red-100 text-red-700 font-semibold rounded-lg hover:bg-red-200 flex items-center gap-2 transition"><i data-lucide="trash-2" class="w-4 h-4"></i>Hapus</button>
                    <button type="button" id="editBtn" class="px-4 py-2.5 bg-indigo-600 text-white font-semibold rounded-lg shadow-sm hover:bg-indigo-700 flex items-center gap-2 transition"><i data-lucide="edit" class="w-4 h-4"></i>Edit</button>
                </div>
            </div>
        </div>
        
        <div id="confirmModal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4">
            <div class="modal-backdrop fixed inset-0 bg-black/50 backdrop-blur-sm"></div>
            <div class="modal-content relative bg-white w-11/12 max-w-sm rounded-2xl shadow-xl p-6 text-center">
                <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100"><i data-lucide="alert-triangle" class="h-6 w-6 text-red-600"></i></div>
                <h3 id="confirmTitle" class="text-lg font-medium text-slate-900 mt-4">Hapus Agenda?</h3>
                <p id="confirmMessage" class="text-sm text-slate-500 mt-2">Tindakan ini tidak dapat dibatalkan.</p>
                <div class="mt-6 flex justify-center gap-3">
                    <button id="confirmCancelBtn" class="px-4 py-2.5 bg-slate-100 text-slate-700 rounded-lg hover:bg-slate-200 w-24 font-semibold transition">Batal</button>
                    <button id="confirmDeleteBtn" class="px-4 py-2.5 bg-red-600 text-white font-semibold rounded-lg shadow-sm hover:bg-red-700 w-24 transition">Hapus</button>
                </div>
            </div>
        </div>

        <div id="cutiModal" class="hidden fixed inset-0 z-40 flex items-center justify-center p-4">
             <div class="modal-backdrop fixed inset-0 bg-black/50 backdrop-blur-sm"></div>
            <div class="modal-content relative bg-white w-11/12 max-w-md rounded-2xl shadow-xl">
                <div class="p-6 border-b"><h2 class="text-2xl font-bold">Tambah Cuti Bersama</h2></div>
                <form id="cutiForm">
                    <div class="p-6 space-y-4">
                        <div><label for="cutiDate" class="block text-sm font-medium text-slate-700 mb-1">Tanggal Cuti</label><input type="date" id="cutiDate" class="w-full px-4 py-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500" required></div>
                        <div><label for="cutiDescription" class="block text-sm font-medium text-slate-700 mb-1">Keterangan</label><input type="text" id="cutiDescription" class="w-full px-4 py-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500" required placeholder="Contoh: Cuti Bersama Idul Fitri"></div>
                    </div>
                    <div class="p-4 sm:p-6 bg-slate-50 rounded-b-2xl flex justify-end gap-3">
                        <button type="button" id="cancelCutiBtn" class="px-5 py-2.5 bg-slate-200 text-slate-700 rounded-lg hover:bg-slate-300 font-semibold transition">Batal</button>
                        <button type="submit" class="px-5 py-2.5 bg-amber-500 text-white font-semibold rounded-lg shadow-sm hover:bg-amber-600 transition">Simpan</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // --- DATA SIMULASI ---
            let allAgendaData = [
                { id: '1', title: 'Rapat Internal Bidang Aptika', start: '2025-08-04T10:00:00', end: '2025-08-04T12:00:00', extendedProps: { perangkatDaerah: 'Dinas Komunikasi dan Informatika', jenisAgenda: 'Internal', tempat: 'Ruang Rapat Aptika', status: 'Terjadwal', createdBy: 'Admin Bidang Aptika', publishWebsite: true, asalSurat: '', pakaian: '', disposisi: '', petugas: '' }},
                { id: '2', title: 'Undangan Workshop Smart City', start: '2025-08-06T09:00:00', end: '2025-08-07T17:00:00', extendedProps: { perangkatDaerah: 'Dinas Komunikasi dan Informatika', jenisAgenda: 'Eksternal', asalSurat: 'Kementerian Kominfo', tempat: 'Hotel Aston, Pontianak', pakaian: 'Batik', disposisi: 'Kadis harap hadir, Kabid Aptika mendampingi.', petugas: 'Kepala Dinas, Kabid Aptika', status: 'Terjadwal', createdBy: 'Admin Dinas', publishWebsite: false }},
                { id: '5', title: 'Sosialisasi SPBE', start: '2025-08-05T09:00:00', end: '2025-08-05T12:00:00', extendedProps: { perangkatDaerah: 'Dinas Komunikasi dan Informatika', jenisAgenda: 'Internal', tempat: 'Aula Diskominfo', status: 'Terjadwal', createdBy: 'Admin Bidang Aptika', publishWebsite: true, asalSurat: '', pakaian: '', disposisi: '', petugas: '' }},
                { id: '8', title: 'Upacara HUT RI', start: '2025-08-17T07:00:00', end: '2025-08-17T09:00:00', extendedProps: { perangkatDaerah: 'Dinas Komunikasi dan Informatika', jenisAgenda: 'Eksternal', asalSurat: 'Sekretariat Daerah', tempat: 'Halaman Kantor Gubernur', pakaian: 'Korpri', disposisi: 'Wajib diikuti.', petugas: 'Seluruh ASN', status: 'Selesai', createdBy: 'Admin Dinas', publishWebsite: false }},
                { id: '10', title: 'Rapat Koordinasi PPID', start: '2025-08-20T13:00:00', end: '2025-08-20T15:00:00', extendedProps: { perangkatDaerah: 'Dinas Komunikasi dan Informatika', jenisAgenda: 'Internal', tempat: 'Ruang Rapat Kadis', status: 'Terjadwal', createdBy: 'Admin Bidang KP', publishWebsite: false, asalSurat: '', pakaian: '', disposisi: '', petugas: '' }},
                { id: '11', title: 'Maintenance Jaringan Kantor', start: '2025-08-22T08:00:00', end: '2025-08-22T17:00:00', extendedProps: { perangkatDaerah: 'Dinas Komunikasi dan Informatika', jenisAgenda: 'Internal', tempat: 'Seluruh Area Kantor', status: 'Dibatalkan', createdBy: 'Admin Bidang Santis', publishWebsite: false, asalSurat: '', pakaian: '', disposisi: '', petugas: '' }},
                { id: '12', title: 'Pelatihan Keamanan Siber', start: '2025-08-25T09:00:00', end: '2025-08-26T16:00:00', extendedProps: { perangkatDaerah: 'Dinas Komunikasi dan Informatika', jenisAgenda: 'Eksternal', asalSurat: 'BSSN', tempat: 'Online via Zoom', pakaian: 'Bebas Rapi', disposisi: 'Bidang Santis menugaskan 2 orang staf.', petugas: 'Staf Bidang Santis', status: 'Terjadwal', createdBy: 'Admin Dinas', publishWebsite: false }},
                { id: '13', title: 'Evaluasi Kinerja Bulanan', start: '2025-08-29T14:00:00', end: '2025-08-29T16:00:00', extendedProps: { perangkatDaerah: 'Dinas Komunikasi dan Informatika', jenisAgenda: 'Internal', tempat: 'Ruang Rapat Utama', status: 'Terjadwal', createdBy: 'Admin Sekretariat', publishWebsite: false, asalSurat: '', pakaian: '', disposisi: '', petugas: '' }},
                { id: '14', title: 'Bimbingan Teknis Aplikasi SIKD', start: '2025-09-02T09:00:00', end: '2025-09-02T15:00:00', extendedProps: { perangkatDaerah: 'Dinas Komunikasi dan Informatika', jenisAgenda: 'Internal', tempat: 'Laboratorium Komputer', status: 'Terjadwal', createdBy: 'Admin Bidang IP', publishWebsite: false, asalSurat: '', pakaian: '', disposisi: '', petugas: '' }},
                { id: '15', title: 'Rapat Sinkronisasi Teknis RTRW', start: '2025-07-31T08:30:00', end: '2025-07-31T16:00:00', extendedProps: { perangkatDaerah: 'Dinas Komunikasi dan Informatika', jenisAgenda: 'Eksternal', asalSurat: 'Dinas PUPR', tempat: 'Aula Dinas PUPR', pakaian: 'Pakaian yang berlaku pada hari itu', disposisi: 'Koordinasikan', petugas: 'Jaya Supriadi', status: 'Terjadwal', createdBy: 'Admin Dinas', publishWebsite: false }}
            ];
            const nationalHolidays = [ { date: '2025-08-17', name: 'Hari Kemerdekaan RI' } ];
            let cutiBersamaData = [];
            
            // --- ELEMEN UI ---
            const ui = {
                login: { container: document.getElementById('login-container'), form: document.getElementById('loginForm'), error: document.getElementById('loginError') },
                app: { container: document.getElementById('app-container'), logoutBtn: document.getElementById('logoutBtn') },
                schedule: { container: document.getElementById('schedule-container') },
                filters: { pd: document.getElementById('pdFilter'), admin: document.getElementById('adminFilter'), month: document.getElementById('monthFilter'), year: document.getElementById('yearFilter') },
                modals: {
                    agenda: { el: document.getElementById('agendaModal'), form: document.getElementById('agendaForm'), title: document.getElementById('modalTitle'), subtitle: document.getElementById('modalPdSubtitle'), eventId: document.getElementById('eventId'), pdValue: document.getElementById('perangkatDaerahValue'), cancelBtn: document.getElementById('cancelBtn') },
                    detail: { el: document.getElementById('detailModal'), title: document.getElementById('detailTitle'), createdBy: document.getElementById('detailCreatedBy'), content: document.getElementById('detailContent'), editBtn: document.getElementById('editBtn'), deleteBtn: document.getElementById('deleteBtn'), closeBtn: document.getElementById('closeDetailBtn') },
                    confirm: { el: document.getElementById('confirmModal'), cancelBtn: document.getElementById('confirmCancelBtn'), deleteBtn: document.getElementById('confirmDeleteBtn') },
                    cuti: { el: document.getElementById('cutiModal'), form: document.getElementById('cutiForm'), cancelBtn: document.getElementById('cancelCutiBtn') }
                },
                buttons: { addAgenda: document.getElementById('addAgendaBtn'), addCuti: document.getElementById('addCutiBtn') },
                formFields: { jenisAgenda: document.getElementById('jenisAgenda'), createdBy: document.getElementById('createdBy'), eksternal: document.getElementById('eksternalFields'), internal: document.getElementById('internalFields') }
            };

            // --- FUNGSI RENDER ---
            function renderSchedule() {
                const selectedMonth = parseInt(ui.filters.month.value);
                const selectedYear = parseInt(ui.filters.year.value);
                let filteredData = allAgendaData.filter(event => {
                    const eventDate = new Date(event.start);
                    return eventDate.getFullYear() === selectedYear && eventDate.getMonth() === selectedMonth 
                        && (ui.filters.admin.value === 'all' || event.extendedProps.createdBy === ui.filters.admin.value);
                });

                const allItems = [
                    ...filteredData.map(e => ({ ...e, type: 'agenda' })),
                    ...nationalHolidays.filter(h => new Date(h.date).getMonth() === selectedMonth).map(h => ({ start: h.date, title: h.name, type: 'holiday' })),
                    ...cutiBersamaData.filter(c => new Date(c.date).getMonth() === selectedMonth).map(c => ({ start: c.date, title: c.name, type: 'cuti' }))
                ].sort((a, b) => new Date(a.start) - new Date(b.start));

                const groupedByDate = allItems.reduce((acc, item) => {
                    const date = new Date(item.start).toISOString().split('T')[0];
                    if (!acc[date]) acc[date] = [];
                    acc[date].push(item);
                    return acc;
                }, {});
                
                if (Object.keys(groupedByDate).length === 0) {
                    ui.schedule.container.innerHTML = `<div class="text-center py-16"><i data-lucide="calendar-x" class="w-20 h-20 mx-auto text-slate-300"></i><p class="mt-5 text-lg text-slate-500">Tidak ada agenda untuk bulan ini.</p></div>`;
                    lucide.createIcons();
                    return;
                }

                let html = '';
                for (const dateStr in groupedByDate) {
                    const items = groupedByDate[dateStr];
                    const date = new Date(dateStr);
                    date.setMinutes(date.getMinutes() + date.getTimezoneOffset());
                    const dayOfWeek = date.getDay();
                    const isWeekend = dayOfWeek === 0 || dayOfWeek === 6;
                    const isHoliday = items.some(item => item.type === 'holiday' || item.type === 'cuti');

                    html += `
                        <div class="md:flex md:gap-6">
                            <div class="md:w-32 flex-shrink-0 mb-4 md:mb-0">
                                <div class="sticky top-28">
                                    <div class="flex items-center gap-3 md:flex-col md:items-start md:gap-0">
                                        <p class="text-lg md:text-xl font-bold ${isWeekend || isHoliday ? 'text-red-500' : 'text-slate-800'}">${date.toLocaleString('id-ID', { weekday: 'long' })}</p>
                                        <p class="text-3xl md:text-5xl font-extrabold ${isWeekend || isHoliday ? 'text-red-400' : 'text-indigo-600'}">${date.toLocaleString('id-ID', { day: 'numeric' })}</p>
                                        <p class="text-lg md:text-xl text-slate-500">${date.toLocaleString('id-ID', { month: 'long' })}</p>
                                    </div>
                                </div>
                            </div>
                            <div class="flex-1 space-y-4 pb-4 border-b md:border-b-0 md:border-l md:pl-6 border-slate-200">
                                ${items.map(item => {
                                    if(item.type === 'holiday') return `<div class="bg-red-50 text-red-700 p-4 rounded-xl text-sm font-semibold">${item.title}</div>`;
                                    if(item.type === 'cuti') return `<div class="bg-amber-50 text-amber-700 p-4 rounded-xl text-sm font-semibold flex justify-between items-center"><span>${item.title}</span><button class="delete-cuti-btn text-amber-500 hover:text-amber-700" data-date="${item.start}"><i data-lucide="trash-2" class="w-4 h-4"></i></button></div>`;
                                    
                                    const props = item.extendedProps;
                                    const { bgColor, textColor, badgeColor, statusText } = getStatusInfo(props.status);
                                    
                                    const time = new Date(item.start).toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' });
                                    const typeInfo = props.jenisAgenda === 'Internal' ? { text: 'Internal', bg: 'bg-blue-100', color: 'text-blue-700'} : { text: 'Eksternal', bg: 'bg-rose-100', color: 'text-rose-700'};

                                    return `
                                        <div class="bg-white rounded-xl border border-slate-200/80 shadow-sm overflow-hidden flex flex-col transition hover:shadow-md hover:border-slate-300">
                                            <div class="p-5">
                                                <div class="flex justify-between items-center mb-3">
                                                    <span class="text-xs font-semibold px-2.5 py-1 rounded-full ${typeInfo.bg} ${typeInfo.color}">${typeInfo.text}</span>
                                                    <span class="text-xs font-semibold px-2.5 py-1 rounded-full ${badgeColor} text-white">${statusText}</span>
                                                </div>
                                                <h4 class="text-lg font-bold text-slate-900 mb-2">${item.title}</h4>
                                                <div class="text-sm text-slate-500 space-y-2">
                                                   <p class="flex items-center gap-2"><i data-lucide="clock" class="w-4 h-4 text-slate-400"></i> ${time}</p>
                                                   <p class="flex items-center gap-2"><i data-lucide="map-pin" class="w-4 h-4 text-slate-400"></i> ${props.tempat}</p>
                                                </div>
                                            </div>
                                            <div class="bg-slate-50 px-5 py-3 flex justify-between items-center">
                                                <span class="text-xs font-medium text-slate-500">${props.createdBy}</span>
                                                <button class="detail-btn text-sm font-semibold text-indigo-600 hover:text-indigo-800" data-id="${item.id}">Lihat Detail</button>
                                            </div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    `;
                }
                ui.schedule.container.innerHTML = html;
                document.querySelectorAll('.detail-btn').forEach(btn => btn.addEventListener('click', (e) => showDetailModal(e.target.dataset.id)));
                document.querySelectorAll('.delete-cuti-btn').forEach(btn => btn.addEventListener('click', (e) => {
                    cutiBersamaData = cutiBersamaData.filter(c => c.date !== e.currentTarget.dataset.date);
                    renderSchedule();
                }));
                lucide.createIcons();
            }

            // --- FUNGSI MODAL & FORM ---
            const adminOptions = { 'Eksternal': ['Admin Dinas'], 'Internal': ['Admin Sekretariat', 'Admin Bidang Aptika', 'Admin Bidang Santis', 'Admin Bidang IP', 'Admin Bidang KP'] };
            function updateFormForJenisAgenda() {
                const jenis = ui.formFields.jenisAgenda.value;
                ui.formFields.eksternal.style.display = jenis === 'Eksternal' ? 'block' : 'none';
                ui.formFields.internal.style.display = jenis === 'Internal' ? 'block' : 'none';
                ui.formFields.createdBy.innerHTML = adminOptions[jenis].map(opt => `<option value="${opt}">${opt}</option>`).join('');
            }

            function openModal(modal) { modal.classList.remove('hidden'); }
            function closeModal(modal) { modal.classList.add('hidden'); }

            function openAddModal() {
                ui.modals.agenda.form.reset();
                ui.modals.agenda.eventId.value = '';
                ui.modals.agenda.title.innerText = 'Tambah Agenda Baru';
                const pd = ui.filters.pd.value;
                ui.modals.agenda.subtitle.innerText = `Untuk: ${pd}`;
                ui.modals.agenda.pdValue.value = pd;
                ui.formFields.jenisAgenda.value = 'Eksternal';
                updateFormForJenisAgenda();
                openModal(ui.modals.agenda.el);
            }
            
            function openEditModal(id) {
                const event = allAgendaData.find(e => e.id === id);
                if (!event) return;
                closeModal(ui.modals.detail.el);
                ui.modals.agenda.form.reset();
                ui.modals.agenda.title.innerText = 'Edit Agenda';
                ui.modals.agenda.subtitle.innerText = `Untuk: ${event.extendedProps.perangkatDaerah}`;
                ui.modals.agenda.eventId.value = event.id;
                ui.modals.agenda.pdValue.value = event.extendedProps.perangkatDaerah;
                ui.formFields.jenisAgenda.value = event.extendedProps.jenisAgenda;
                updateFormForJenisAgenda();
                Object.keys(event.extendedProps).forEach(key => {
                    const el = document.getElementById(key);
                    if (el) {
                        if (el.type === 'checkbox') el.checked = event.extendedProps[key];
                        else el.value = event.extendedProps[key];
                    }
                });
                document.getElementById('perihal').value = event.title;
                document.getElementById('waktuMulai').value = event.start.substring(0, 16);
                document.getElementById('waktuSelesai').value = event.end ? event.end.substring(0, 16) : '';
                ui.formFields.createdBy.value = event.extendedProps.createdBy;
                openModal(ui.modals.agenda.el);
            }

            function showDetailModal(id) {
                const event = allAgendaData.find(e => e.id === id);
                if (!event) return;
                const props = event.extendedProps;
                ui.modals.detail.title.innerText = event.title;
                ui.modals.detail.createdBy.innerHTML = `Diinput oleh <span class="font-semibold text-slate-800">${props.createdBy}</span>`;

                const detailItem = (icon, label, value) => `<div class="flex items-start gap-4"><i data-lucide="${icon}" class="w-5 h-5 text-indigo-500 mt-1 flex-shrink-0"></i><div><h4 class="font-semibold text-slate-800">${label}</h4><p class="text-slate-600 break-words">${value || '-'}</p></div></div>`;
                let detailHtml = `<div class="grid grid-cols-1 sm:grid-cols-2 gap-x-6 gap-y-5">
                        ${detailItem('calendar', 'Waktu Pelaksanaan', formatDateRange(event.start, event.end))}
                        ${detailItem('map-pin', 'Tempat', props.tempat)}
                    </div>`;
                if (props.jenisAgenda === 'Eksternal') {
                    detailHtml += `<div class="border-t my-5"></div><div class="grid grid-cols-1 sm:grid-cols-2 gap-x-6 gap-y-5">
                            ${detailItem('building', 'Penyelenggara', props.asalSurat)}
                            ${detailItem('shirt', 'Pakaian', props.pakaian)}
                            ${detailItem('file-text', 'Disposisi', props.disposisi)}
                            ${detailItem('users', 'Petugas', props.petugas)}
                        </div>`;
                } else {
                    detailHtml += `<div class="border-t my-5"></div>${detailItem('globe', 'Publikasi Website', props.publishWebsite ? 'Ya, dipublikasikan' : 'Tidak')}`;
                }
                ui.modals.detail.content.innerHTML = detailHtml;
                lucide.createIcons();
                ui.modals.detail.editBtn.onclick = () => openEditModal(event.id);
                ui.modals.detail.deleteBtn.onclick = () => { openModal(ui.modals.confirm.el); ui.modals.confirm.deleteBtn.dataset.id = event.id; };
                openModal(ui.modals.detail.el);
            }

            // --- EVENT LISTENERS ---
            ui.login.form.addEventListener('submit', (e) => {
                e.preventDefault();
                if (document.getElementById('username').value === 'admin' && document.getElementById('password').value === 'admin123') {
                    ui.login.container.classList.add('hidden');
                    ui.app.container.classList.remove('hidden');
                    ui.login.error.classList.add('hidden');
                    renderSchedule();
                } else {
                    ui.login.error.classList.remove('hidden');
                }
            });

            ui.app.logoutBtn.addEventListener('click', () => {
                ui.app.container.classList.add('hidden');
                ui.login.container.classList.remove('hidden');
                document.getElementById('password').value = '';
            });

            ui.buttons.addAgenda.addEventListener('click', openAddModal);
            ui.buttons.addCuti.addEventListener('click', () => openModal(ui.modals.cuti.el));
            [ui.modals.agenda.cancelBtn, ui.modals.cuti.cancelBtn, ui.modals.detail.closeBtn, ui.modals.confirm.cancelBtn]
                .forEach(btn => btn.addEventListener('click', () => btn.closest('.fixed').classList.add('hidden')));
            
            document.querySelectorAll('.modal-backdrop').forEach(bd => bd.addEventListener('click', () => bd.parentElement.classList.add('hidden')));

            ui.formFields.jenisAgenda.addEventListener('change', updateFormForJenisAgenda);

            ui.modals.agenda.form.addEventListener('submit', function(e) {
                e.preventDefault();
                const id = ui.modals.agenda.eventId.value;
                const newEventData = {
                    title: document.getElementById('perihal').value, start: document.getElementById('waktuMulai').value, end: document.getElementById('waktuSelesai').value,
                    extendedProps: {
                        perangkatDaerah: ui.modals.agenda.pdValue.value, jenisAgenda: ui.formFields.jenisAgenda.value, tempat: document.getElementById('tempat').value, status: document.getElementById('status').value, createdBy: ui.formFields.createdBy.value,
                        publishWebsite: ui.formFields.jenisAgenda.value === 'Internal' ? document.getElementById('publishWebsite').checked : false,
                        asalSurat: ui.formFields.jenisAgenda.value === 'Eksternal' ? document.getElementById('asalSurat').value : '', pakaian: ui.formFields.jenisAgenda.value === 'Eksternal' ? document.getElementById('pakaian').value : '', disposisi: ui.formFields.jenisAgenda.value === 'Eksternal' ? document.getElementById('disposisi').value : '', petugas: ui.formFields.jenisAgenda.value === 'Eksternal' ? document.getElementById('petugas').value : ''
                    }
                };
                if (id) {
                    const index = allAgendaData.findIndex(event => event.id === id);
                    allAgendaData[index] = { id, ...newEventData };
                } else {
                    allAgendaData.push({ id: Date.now().toString(), ...newEventData });
                }
                renderSchedule();
                closeModal(ui.modals.agenda.el);
            });

            ui.modals.cuti.form.addEventListener('submit', function(e) {
                e.preventDefault();
                const date = document.getElementById('cutiDate').value, desc = document.getElementById('cutiDescription').value;
                if(date && desc && !cutiBersamaData.some(c => c.date === date)) {
                    cutiBersamaData.push({ date, name: desc });
                    renderSchedule();
                    closeModal(ui.modals.cuti.el);
                }
            });
            
            ui.modals.confirm.deleteBtn.addEventListener('click', function() {
                allAgendaData = allAgendaData.filter(e => e.id !== this.dataset.id);
                closeModal(ui.modals.confirm.el);
                closeModal(ui.modals.detail.el);
                renderSchedule();
            });

            Object.values(ui.filters).forEach(filter => filter.addEventListener('change', renderSchedule));

            // --- FUNGSI BANTU ---
            function populateDateFilters() {
                const months = ["Januari", "Februari", "Maret", "April", "Mei", "Juni", "Juli", "Agustus", "September", "Oktober", "November", "Desember"];
                const defaultYear = 2025, defaultMonth = 7;
                ui.filters.month.innerHTML = months.map((m, i) => `<option value="${i}" ${i === defaultMonth ? 'selected' : ''}>${m}</option>`).join('');
                let yearHtml = '';
                for (let i = defaultYear - 5; i <= defaultYear + 5; i++) yearHtml += `<option value="${i}" ${i === defaultYear ? 'selected' : ''}>${i}</option>`;
                ui.filters.year.innerHTML = yearHtml;
            }

            function getStatusInfo(status) {
                switch (status) {
                    case 'Selesai': return { statusText: 'Selesai', badgeColor: 'bg-green-500' };
                    case 'Dibatalkan': return { statusText: 'Dibatalkan', badgeColor: 'bg-slate-500' };
                    default: return { statusText: 'Terjadwal', badgeColor: 'bg-indigo-500' };
                }
            }

            function formatDateRange(start, end) {
                const dateOptions = { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric', timeZone: 'Asia/Jakarta' };
                const timeOptions = { hour: '2-digit', minute: '2-digit', hour12: false, timeZone: 'Asia/Jakarta' };
                const startDate = new Date(start), endDate = new Date(end);
                if (!end || startDate.toDateString() === endDate.toDateString()) {
                    return `${startDate.toLocaleDateString('id-ID', dateOptions)} • Pukul ${startDate.toLocaleTimeString('id-ID', timeOptions)} - ${endDate.toLocaleTimeString('id-ID', timeOptions)}`;
                }
                return `${startDate.toLocaleString('id-ID', {...dateOptions, ...timeOptions})} s/d ${endDate.toLocaleString('id-ID', {...dateOptions, ...timeOptions})}`;
            }

            // --- INISIALISASI ---
            lucide.createIcons();
            populateDateFilters();
            updateFormForJenisAgenda();
        });
    </script>
</body>
</html>
